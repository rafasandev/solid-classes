ANOTAÇÕES GERAIS

- Ao criar um usuário novo, ele pode ser tanto um comprador quanto um vendedor. Informações básicas para um usuário: email, senha e status.
- Se for um comprador, as informações adicionais do perfil são: nome e cpf.
- Se for um vendedor, as informações adicionais são: nome da loja, cnpj e setor de atuação (Comércio ou Serviço).

- comprador
    - Ao registrar um novo comprador, um novo carrinho vazio é criado, vinculado ao ID do usuário
    - Ao finalizar um pedido, o carrinho do comprador é esvaziado e atualizado, nunca deletado
    - O novo comprador é registrado com o status inativo, devendo completar o perfil com ao menos um meio de contato
- vendedor
    - O vendedor é registrado com informações básicas, mas status inativo. Só será dado como ativo após configurar disponibilidade e ao menos um meio de contato (DESENVOLVIMENTO PENDENTE)
    - O vendedor é registrado com um saldo inicial de 0
    - Os meios de pagamento serão configurados com o envio da seguinte estrutura de dados:
        paymentMethodIds: [uuid, uuid, uuid, ...]
    - A disponibilidade do vendedor será configurada com o envio da seguinte estrutura de dados:
        weekDaysAvailable : [1,2,3,4,5] (1=Domingo, 2=Segunda, ..., 7=Sábado)
        dailyAvailability(List<CompanyDailyAvailabilityForm>): [
            {
                weekDay: 1,
                timeRanges (List<TimeRangeForm>): [
                    {
                        startTime: "08:00",
                        endTime: "12:00"
                    },
                    {
                        startTime: "14:00",
                        endTime: "18:00"
                    }
                ]
            },
            {
                weekDay: 2,
                timeRanges (List<TimeRangeForm>): [
                    {
                        startTime: "09:00",
                        endTime: "17:00"
                    }
                ]
            }
        ]

- Ambos perfis devem configurar ao menos um meio de contato para serem ativados
- Depois da configuração dos perfis, o status dos usuários deve ser alterado para ATIVO
- A verificação do status ativo/inativo é feita com um método interno no modelo do Profile (individualIsAbleToBeActive e companyIsAbleToBeActive)
- Para evitar duplicação de código, a verificação será feita no serviço de salvamento do perfil, em IndividualProfileService e CompanyProfileService

- Apenas ADMINS podem criar categorias de produtos no sistema
- Produtos são criados com: nome, descrição, preço base, quantidade em estoque e categoria
- Produtos não podem ser criados com variações inicialmente

- O cálculo de quantidade de estoque do produto é feito de forma automática no Service dele, não sendo alterado por métodos internos
- A quantidade é calculada com base nas quantidades individuais das variações de produto

- Ao requisitar o fechamento do pedido, o sistema deve:
    - Verificar se o usuário atual logado é um comprador
    - Buscar o carrinho do comprador
    - Validar se o carrinho não está vazio
    - Validar se os itens (product variations) estão disponíveis e com estoque suficiente
    - Separa os itens por vendedor (Map <CompanyProfile, List<CartItem>>)
    - O pedido original será repartido para vários pedidos, um para cada vendedor
    - Para cada item do mapa, será calculado o total parcial daquele vendedor
    - Será criado um Order para o vendedor, com o status PENDENTE e o código de confirmação único
    - Será criado um snapshot dos itens do pedido, vinculados ao pedido
    - O estoque dos produtos será ajustado conforme os itens do pedido
    - O carrinho do comprador será esvaziado e atualizado
    - Todos os dados dos itens do pedido serão persistidos nos snapshots, para evitar perda de dados futuros

- O pedido passa por várias etapas de status:
    - PENDENTE, // Pedido Gerado
        - O pedido é criado com esse status, aguardando confirmação do vendedor para prosseguir
    
    - PEDIDO_CANCELADO, // Pedido cancelado enquanto está pendente (Sem penalização)
        - O pedido pode ser cancelado pelo vendedor ou comprador nessa etapa, antes de ser pago ou estar pronto para a retirada.
        - O pedido de cancelamento pode ser feito por meio de contato externo (chat, email, telefone) e o vendedor pode atualizar o status para PEDIDO_CANCELADO

    - PROCESSANDO, // Pedido em processamento
        - O vendedor confirmou o recebimento do pedido e está preparando-o ou separando itens para retirada
    
    - CANCELADO_PROCESSANDO, // Pedido cancelado durante o processamento (Penalização de 1 ponto)
        - O pedido pode ser cancelado pelo vendedor nessa etapa, antes de estar pronto para a retirada.
        - O pedido de cancelamento pode ser feito por meio de contato externo (chat, email, telefone) e o vendedor pode atualizar o status para CANCELADO_PROCESSANDO

    - PRONTO_RETIRADA, // Aguardando o cliente buscar
        - O pedido está pronto para ser retirado pelo cliente no local do vendedor
        - O cliente deve retirar o pedido dentro do prazo estabelecido pelo vendedor
        - Se o cliente não retirar o pedido dentro do prazo, o status muda para EXPIRADO

    - CANCELADO_RETIRADA, // Pedido cancelado quando estava pronto para retirada antes de expirar (Penalização de 1 ponto)
        - O pedido pode ser cancelado pelo vendedor nessa etapa, antes de expirar.
        - O pedido de cancelamento pode ser feito por meio de contato externo (chat, email, telefone) e o vendedor pode atualizar o status para CANCELADO_RETIRADA

    - COMPLETADO, // Produto entregue
        - O cliente informou o código de compra e retirou o pedido e o vendedor atualizou o status para COMPLETADO
        - O pedido é finalizado e o valor é creditado na conta do vendedor

    - EXPIRADO, // Pedido expirado (Penalização de 2 pontos)
        - O pedido não foi retirado pelo cliente dentro do prazo estabelecido pelo vendedor
        - O pedido ainda pode permanecer nesse status pelo tempo de escolha do vendedor

    - COMPLETADO_EXPIRADO // Pedido completado após expiração (Mantém penalização de 2 pontos)
        - O cliente retirou o pedido após o status EXPIRADO
        - O vendedor atualiza o status manualmente para COMPLETADO_EXPIRADO
        - O valor é creditado normalmente na conta do vendedor
        - Um admin pode auditar a penalização do cliente, se necessário

    - SEM_RETIRADA // Pedido não retirado pelo cliente (Penalização de 3 pontos)
        - O pedido não foi retirado pelo cliente dentro do prazo estabelecido pelo vendedor (Não houve tentativa de contato ou o produto ficou retido por muito tempo)
        - O pedido não pode mais ser completado e fica nesse status permanentemente
    
- Os status não devem estar todos disponíveis de uma vez
- Cada status deve ser alterado conforme o fluxo definido acima
- Maneiras de implementar esse fluxo de forma bem estruturada:
    - Criar um serviço dedicado para gerenciar as mudanças de status, encapsulando a lógica de negócio
    - Validar todas as condições necessárias antes de permitir a mudança de status
    - O service deve ser responsável por listar e alterar os status possíveis para o pedido, baseado no status atual e verificações secundárias
        - RECUPERAÇÃO DE STATUS PERMITIDOS:
            - Todos os status tem uma lista de status permitidos para mudança
            - Cada status pode ter verificações adicionais para permitir a mudança
            - Verificações adicionais por status:
                - COMPLETADO:
                    - Verificar código de confirmação
                    - Atualizar saldo do vendedor
                - EXPIRADO:
                    - Verificar se o prazo de retirada expirou
                - EXPIRADO_COMPLETADO:
                    - Verificar código de confirmação

        - ALTERAÇÃO DE STATUS:
            - Receber o ID do pedido
            - Receber o ID do cliente do pedido (sempre verificar se o cliente é o dono do pedido)
            - Receber o status desejado para mudança
            - Validar se o pedido pertence ao cliente
            - Validar se a mudança de status é permitida
            - Executar verificações adicionais conforme o status desejado
            - Atualizar o status do pedido
            - Persistir as mudanças no banco de dados

- SISTEMA DE VENDA PRESENCIAL
    - O vendedor pode registrar vendas presenciais dentro da aplicação
    - Para isso, seria melhor criar um carrinho ou grupo de itens, já que o carrinho foi feito para agregar vários vendedores, mas nesse caso só haveria um vendedor
    - O vendedor adiciona os itens ao carrinho, informa o comprador (pode ser um comprador genérico ou um comprador específico)
    - O vendedor finaliza o pedido, que segue o mesmo fluxo de pedidos online, mas com status diferente
    - O pedido presencial pode ter os seguintes status:
        - FINALIZADO_PRESENCIAL (Pedido finalizado presencialmente)
    - Não são necessários status de processamento, retirada ou expiração, já que o pedido é finalizado na hora
    - O pedido presencial pode ser auditado posteriormente, mas não há necessidade de um fluxo complexo
    - O saldo do vendedor é atualizado imediatamente após a finalização do pedido presencial
    - ENTIDADES DA VENDA PRESENCIAL
        - O product já existe, não é necessário criar uma nova entidade
        - É melhor criar um novo tipo de carrinho ou reutilizar o existente ? Reutilizar o carrinho existente, mas garantir que ele possa ser vinculado a um único vendedor
        - Seguindo a entidade do carrinho atual, ele é vinculado ao comprador e os cartItens, que são os itens do carrinho
        - Então o carrinho atual não pode ser reutilizado, pois o perfil de abertura dele é um vendedor (companyprofile) e não um cliente (individualprofile)
        - Portanto, é melhor criar uma nova entidade chamada PresencialCart, que é vinculada ao vendedor e contém os PresencialCartItems
        - O PresencialCartItem é semelhante ao CartItem, mas vinculado ao PresencialCart
        - O PresencialCartItem contém a productVariation, quantidade e preço unitário no momento da venda
        - O PresencialCart é vinculado ao vendedor (companyProfile) e ao comprador (individualProfile ou um comprador genérico)
        - O PresencialCart pode ser finalizado, criando um Order com status FINALIZADO_PRESENCIAL
        - O PresencialCart vai gerar apenas um pedido, diferentemente do carrinho normal que pode gerar vários pedidos para diferentes vendedores
        - O PresencialCartItem precisa armazenar o preço unitário no momento da venda, para evitar problemas futuros com alterações de preço, criando um snapshot simples
        - O que é necessário na snapshot:
            - id do productVariation
            - id do produto pai
            - nome do produto
            - quantidade
            - preço unitário no momento da venda
        - É indicado fazer uma indexação dos pedidos presenciais para facilitar auditorias futuras ? Sim, é uma boa prática
        - É melhor que esse carrinho seja apenas registrado a cada nova compra ? Sim, não há necessidade de manter um carrinho aberto para vendas presenciais
        - O vendedor pode registrar vendas presenciais para compradores genéricos ou específicos
        - O carrinho normal pode ser apenas esvaziado após a finalização do pedido, mas o PresencialCart deve ser criado e finalizado a cada venda presencial
        - Faz sentido ? Sim, dessa forma o sistema fica mais organizado e fácil de auditar. Mas e a auditoria do carrinho normal ?
        - A auditoria do carrinho normal é feita por meio dos pedidos gerados, que contém snapshots dos itens do pedido
        - Portanto, não há necessidade de manter um histórico do carrinho normal, apenas dos pedidos gerados
        - O PresencialCart é uma entidade temporária, criada para cada venda presencial e finalizada imediatamente
        - O sistema deve permitir que o vendedor registre vendas presenciais de forma simples e rápida
        - O vendedor pode adicionar itens ao PresencialCart, informar o comprador e finalizar a venda
        - O sistema cria o pedido correspondente e atualiza o saldo do vendedor
        - A auditoria das vendas presenciais pode ser feita por meio dos pedidos gerados
        - o CartItem normal tem que ter snapshots dos produtos também ? Sim, para garantir a integridade dos dados dos pedidos
        - Mas e se um valor mudar no meio tempo ? O snapshot do CartItem deve armazenar o preço unitário no momento da venda, assim como o PresencialCartItem
        - Mas o OrderItem já não faz isso ? Sim, o OrderItem já armazena essas informações, então não há necessidade de duplicar no CartItem
        - Portanto, o CartItem pode permanecer simples, apenas vinculando ao productVariation e quantidade
        - O OrderItem é o responsável por armazenar o snapshot dos dados do produto no momento da venda
        - Isso mantém o sistema mais limpo e evita duplicação de dados desnecessária
        - Estrutura do CartITem Atual: 
            - id (UUID)
            - productVariationId (UUID)
            - productId (UUID)
            - productName (String)
            - itemQuantity (int)
            - unitPriceSnapshot (BigDecimal)
            - cart (Cart)
        - Estrutura do CartITem Proposta (sem snapshot, apenas referência):
            - id (UUID)
            - productVariationId (UUID)
            - itemQuantity (int)
            - cart (Cart)

        - Após a compra presencial, vai ser criado um pedido da mesma forma que o online
        - Portanto, o OrderItem vai armazenar o snapshot dos dados do produto no momento da venda
        - O OrderItem já existe e armazena essas informações, então não há necessidade de duplicar no PresencialCartItem

        - Lista de entidades:
            - PresencialCart
                - id (UUID)
                - seller (CompanyProfile)
                - buyer (IndividualProfile ou null para comprador genérico)
                - createdAt (Timestamp)
                - updatedAt (Timestamp)
                - PresencialCartItems (List<PresencialCartItem>)
            - PresencialCartItem
                - id (UUID)
                - PresencialCart (PresencialCart)
                - productVariation (ProductVariation)
                - quantity (int)
        
        - Fluxo de venda presencial:
            - O vendedor cria um novo PresencialCart
            - O vendedor indica o comprador (null para comprador genérico), a partir o cpf ou id do comprador (DESENVOLVIMENTO DE UM CÓDIGO DE IDENTIFICAÇÃO SEGURO PARA CLIENTES)
            - Ele vai adicionando e configurando os novos PresencialCartItems
            - Quando finalizar a compra, o vendedor finaliza o PresencialCart
            - O sistema cria um novo Order com status FINALIZADO_PRESENCIAL
            - O saldo do vendedor é atualizado imediatamente

- SISTEMA DE CONTROLE DE ESTOQUE DE PRODUTOS
    - O sistema deve dar um controle de estoque eficiente para os vendedores
    - Cada variação de produto deve ter sua própria quantidade em estoque
    - O estoque é ajustado automaticamente ao finalizar pedidos
    - O vendedor deve poder alterar o estoque manualmente, se necessário, de acordo com a produção ou recebimento de mercadorias
    - O sistema deve validar o estoque disponível ao adicionar itens ao carrinho
    - Se não houver estoque suficiente, o sistema deve impedir a adição do item ao carrinho

    - EDIÇÃO MANUAL DE ESTOQUE PELO VENDEDOR
        - O vendedor pode ajustar o estoque manualmente por meio de uma interface dedicada
        - O vendedor informa a variação do produto e a nova quantidade em estoque
        - O sistema valida a entrada e atualiza o estoque no banco de dados
        - Será verificado o usuário logado e se ele é o dono do produto antes de permitir a alteração do estoque
        - A nova quantidade deve ser um número inteiro não negativo
        
- FLUXO RESUMIDO DO SISTEMA
    - ADMINS
        - CRIAÇÃO DE CATEGORIAS DE PRODUTOS E SERVIÇOS
        - CRIAÇÃO DAS CATEGORIAS DE VARIAÇÕES DE PRODUTOS E SERVIÇOS (VariationCategoryGlobal)
        - CRIAÇÃO DOS TIPOS DE MEIOS DE CONTATO (ContactType)
        - CRIAÇÃO DOS MEIOS DE PAGAMENTO DISPONÍVEIS (PaymentMethod)

    - USERS
        - REGISTRO DE VENDEDOR (EMPRESA)
        - REGISTRO DE CLIENTE (INDIVIDUAL) E CONSEQUENTE CRIAÇÃO DE CARRINHO VAZIO
        - CONFIGURAÇÃO DE MEIOS DE CONTATO (EMPRESA E INDIVIDUAL)
        - ATIVAÇÃO DE PERFIL APÓS CONFIGURAÇÃO

    - SELLERS (EMPRESAS)
        - CONFIGURAÇÃO DE HORÁRIOS E FORMAS DE PAGAMENTO (CompanyDailyAvailability e PaymentMethod)
        - CRIAÇÃO DE CATEGORIAS PERSONALIZADAS DE VARIAÇÃO POR VENDEDOR (VariationCategorySeller)
        - CRIAÇÃO DE PRODUTOS E SUAS RESPECTIVAS VARIAÇÕES (Product e ProductVariation)
        - CONTROLE DE ESTOQUE DE VARIAÇÕES DE PRODUTOS
        - REGISTRO DE VENDAS PRESENCIAIS (PresencialCart e PresencialCartItem)
        - ALTERAÇÃO MANUAL DOS STATUS DOS PEDIDOS

    - BUYERS (INDIVIDUAL)
        - ADIÇÃO DE ITENS NO CARRINHO (Cart e CartItem)
        - FECHAMENTO DE PEDIDOS (Order e OrderItem)
        - RETIRADA DE PEDIDOS NO LOCAL DO VENDEDOR COM VALIDAÇÃO DE CÓDIGO DE COMPRA
        - COMUNICAÇÃO EXTERNA COM O VENDEDOR SOBRE OS PEDIDOS
    
    - AUTO
        - Adição de penalidades com o andamento de status de pedidos (Penalty)
        - Ajuste automático de estoque ao finalizar pedidos
        - Crédito automático do saldo do vendedor ao completar pedidos
        - Esvaziamento automático do carrinho ao finalizar pedidos
        - Verificação automática de disponibilidade de itens e estoque ao fechar pedidos
        - Verificação automática de status ativo/inativo dos perfis
        - Mudança de status de produtos ao alterar o estoque
        - Geração automática de snapshots dos itens do pedido ao finalizar pedidos
        - Geração de códigos únicos de confirmação para pedidos
        - Geração automática de timestamps de criação e atualização das entidades

- ENTIDADES PRINCIPAIS DO SISTEMA
    - User
    - IndividualProfile
    - CompanyProfile
        - CompanyDailyAvailability
    - ContactType
    - ContactInfo
    - PaymentMethod
    - VariationCategoryGlobal
    - VariationCategorySeller
    - Product
    - ProductVariation
    - Cart
    - CartItem
    - PresencialCart
    - PresencialCartItem
    - Order
    - OrderItem
    - Category
    - ServiceOffering
    - Penalty